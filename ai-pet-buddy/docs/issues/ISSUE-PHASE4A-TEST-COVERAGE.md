# Phase 4-A: テストカバレッジの90%以上への回復 (Phase 4-A: Restore Test Coverage to 90%+)

## 概要 (Overview)
プロジェクトの健全性と品質を維持するため、テストカバレッジを目標値である90%以上に回復・維持する必要があります。最近の機能追加やリファクタリングにより、一部モジュールでカバレッジが低下している可能性があります。このIssueでは、カバレッジレポートを分析し、テストが不足している箇所を特定して、必要なテスト（単体テスト、統合テスト、UIテスト）を追加します。

## 関連ドキュメント (Related Documents)
- **テスト戦略:** `docs/development-standards/TESTING-STRATEGY.md`
- **Vitest設定:** `vitest.config.ts` (カバレッジ設定含む)
- **package.json:** テスト実行・カバレッジ生成スクリプト (`scripts` セクション)
- **開発ルール:** プロジェクトルートの `AI-PET-DEVELOPMENT-PLAN.md` や `DEVELOPMENT-STANDARDS.md` (仮)

## 期待される動作 (Expected Behavior)
- プロジェクト全体のテストカバレッジ（行カバレッジ、関数カバレッジ、ブランチカバレッジ）が90%以上になる。
- 新しく追加されたテストは意味があり、コードの品質向上に寄与する。
- カバレッジ向上のための作業が、既存のテストやアプリケーションの動作に悪影響を与えない。

## 現在の動作 (Current Behavior)
テストカバレッジが目標の90%を下回っている可能性がある。具体的な数値は最新のカバレッジレポートで確認する必要がある。

## 関連ファイル (Relevant Files - Expected to be modified/created)
- **テストファイル:** `src/**/*.test.ts`, `src/**/*.test.tsx` (既存ファイルの拡充、新規作成)
- **カバレッジレポート:** `coverage/` ディレクトリ (分析対象、作業後に再生成して確認)
- **テスト対象ソースコード:** `src/**/*.ts`, `src/**/*.tsx` (テスト対象となる全ファイル)

## 開発者向け指示 (Instructions for AI Agent)
- **優先度 (Priority):** Medium
- **目標 (Goal):** プロジェクト全体のテストカバレッジ（行、関数、ブランチの各項目）を90%以上に向上させる。
- **具体的なタスク (Specific Tasks):**
    1. **カバレッジレポート生成:** `npm run test -- --coverage` (または `package.json` で定義されたカバレッジ生成コマンド) を実行し、最新のカバレッジレポートを生成する。通常、`coverage/lcov-report/index.html` などで視覚的に確認できる。
    2. **カバレッジ分析:**
        - 生成されたカバレッジレポートを詳細に分析し、カバレッジが低いモジュール、ファイル、関数、および未テストのコードブランチ（if/else, switchの各ケース、エラーパスなど）を特定する。
        - 特に `src/utils/`, `src/hooks/`, `src/components/` ディレクトリ内のファイルの状況に注意する。
    3. **テストケースの設計と追加:**
        - 特定されたカバレッジの低い箇所に対して、不足しているテストケースを設計し、追加する。
        - **単体テスト (`*.test.ts`):** 主に `src/utils/` や `src/hooks/` 内のビジネスロジック、純粋関数、カスタムフックの内部ロジックに対して。
        - **UIテスト/コンポーネントテスト (`*.test.tsx`):** 主に `src/components/` 内のReactコンポーネントのレンダリング結果、ユーザーインタラクション、状態変更に対して。React Testing Library を使用する。
        - **ブランチカバレッジ向上:** 条件分岐の各パス（真偽両方）、エラーハンドリング（try/catchブロック）、境界値、エッジケースを網羅するようにテストを追加する。
    4. **テストの質:** 単にカバレッジの数値を上げるためだけのテストではなく、意味のあるアサーションを行い、バグを発見しやすく、リファクタリングに対する耐性があるテストを作成する。
    5. **繰り返し検証:** テストを追加するたびに、またはある程度のまとまりで再度カバレッジレポートを生成し、目標（90%以上）に近づいているか、また他のテストに影響が出ていないか確認する。
- **考慮事項 (Considerations):**
    - **テスト戦略の遵守:** `docs/development-standards/TESTING-STRATEGY.md` に記載されているテスト方針（テストの種類、責務範囲など）に従う。
    - **既存テストの尊重:** 既存のテストが失敗するようになった場合は、リグレッションの可能性があるため、原因を調査し修正する。安易に既存テストを削除したり、緩めたりしない。
    - **モックの適切な使用:** 外部依存関係（API呼び出し、`localStorage`など）は適切にモックする。
    - **テストの可読性と保守性:** テストコードも本番コードと同様に、可読性が高く保守しやすいように記述する。適切な命名、構造化、コメントを心がける。
- **テスト要件 (Testing Requirements):**
    - 新しく追加されたテストはすべて成功すること。
    - 既存のテストスイート全体が引き続きすべて成功すること。
    - `vitest run --coverage` (または同等のコマンド) で生成されるカバレッジレポートで、行、関数、ブランチの各カバレッジがそれぞれ90%以上を達成していること。
- **完了条件 (Acceptance Criteria):**
    - プロジェクト全体のテストカバレッジ（行、関数、ブランチ）が90%以上である。
    - 追加されたテストが、テスト対象コードの振る舞いを適切に検証しており、品質向上に貢献している。
    - すべてのテスト (`npm run test:run`) が成功する。
    - コード変更は、既存のESLintルールおよびプロジェクトのコーディング規約に準拠する。

## 参照情報 (References)
- Vitest ドキュメント: Coverage
- React Testing Library ドキュメント
- Istanbul.js (Vitestが内部で使用するカバレッジツール)
